<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Trading Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #f7931a;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        h1 span {
            color: #e0e0e0;
            font-weight: normal;
        }

        /* Two-column layout for desktop */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .left-column, .right-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Header Info Grid */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        @media (min-width: 768px) {
            .info-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .info-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .info-card .label {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-card .value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #f7931a;
        }

        .info-card .value.green { color: #4caf50; }
        .info-card .value.red { color: #f44336; }
        .info-card .value.blue { color: #627eea; }

        /* Settlement time badge */
        .settlement-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #4caf50;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Section Cards */
        .section-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section-card h2 {
            font-size: 1rem;
            margin-bottom: 12px;
            color: #f7931a;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-card h2 .badge {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: normal;
        }

        .section-card h2 .badge.green {
            background: rgba(76, 175, 80, 0.3);
            color: #4caf50;
        }

        .section-card h2 .badge.blue {
            background: rgba(98, 126, 234, 0.3);
            color: #627eea;
        }

        .section-card h2 .badge.yellow {
            background: rgba(255, 212, 59, 0.3);
            color: #ffd43b;
        }

        /* Controls */
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            color: #888;
            font-size: 0.75rem;
            text-transform: uppercase;
        }

        .control-group input, .control-group select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 10px 12px;
            color: #e0e0e0;
            font-size: 1rem;
            width: 100%;
        }

        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: #f7931a;
        }

        /* Refresh Button */
        .refresh-btn {
            display: block;
            width: 100%;
            margin-bottom: 20px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #f7931a 0%, #e67e22 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(247, 147, 26, 0.4);
        }

        .refresh-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #fff;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th, td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(247, 147, 26, 0.15);
            color: #f7931a;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: rgba(247, 147, 26, 0.05);
        }

        .positive { color: #4caf50; font-weight: 600; }
        .negative { color: #f44336; }
        .pending { color: #ff9800; }

        /* Chart container */
        .chart-container {
            height: 180px;
            position: relative;
        }

        canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* Volatility Stop Banner */
        .vol-stop-banner {
            background: linear-gradient(135deg, #f44336 0%, #c62828 100%);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
            display: none;
            font-size: 0.9rem;
        }

        .vol-stop-banner.active {
            display: block;
        }

        /* Trade Log */
        .trade-item {
            display: grid;
            grid-template-columns: 1fr 1.5fr 1.5fr 1fr;
            gap: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.8rem;
        }

        .trade-item:last-child {
            border-bottom: none;
        }

        /* Status Messages */
        .status {
            text-align: center;
            padding: 15px;
            color: #888;
            font-style: italic;
            font-size: 0.85rem;
        }

        /* Mobile toggle button */
        .mobile-toggle {
            display: none;
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 0.85rem;
            cursor: pointer;
        }

        @media (max-width: 900px) {
            .mobile-toggle {
                display: block;
            }
            .hide-mobile {
                display: none !important;
            }
            .hide-mobile.show {
                display: block !important;
            }
        }

        /* Error message */
        .error-message {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #f44336;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 15px;
            color: #666;
            font-size: 0.75rem;
            margin-top: 20px;
        }

        .footer a {
            color: #f7931a;
            text-decoration: none;
        }

        /* Last updated timestamp */
        .last-updated {
            text-align: center;
            color: #666;
            font-size: 0.7rem;
            margin-top: 10px;
        }

        /* ETH section styling */
        .eth-section h2 {
            color: #627eea;
        }

        .eth-section th {
            background: rgba(98, 126, 234, 0.15);
            color: #627eea;
        }

        .eth-section tr:hover {
            background: rgba(98, 126, 234, 0.05);
        }

        /* Scrollable table wrapper */
        .table-wrapper {
            overflow-x: auto;
            margin: 0 -15px;
            padding: 0 15px;
        }

        /* IRR Stats Card */
        .irr-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        @media (max-width: 600px) {
            .irr-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .irr-stat {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }

        .irr-stat .stat-label {
            font-size: 0.65rem;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .irr-stat .stat-value {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .irr-stat .stat-value.positive { color: #4caf50; }
        .irr-stat .stat-value.negative { color: #f44336; }

        /* Trade log table styles */
        .trade-log-table {
            font-size: 0.75rem;
        }

        .trade-log-table th {
            font-size: 0.65rem;
            padding: 8px 4px;
        }

        .trade-log-table td {
            padding: 6px 4px;
        }

        .asset-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: bold;
        }

        .asset-badge.btc {
            background: rgba(247, 147, 26, 0.2);
            color: #f7931a;
        }

        .asset-badge.eth {
            background: rgba(98, 126, 234, 0.2);
            color: #627eea;
        }

        .pnl-positive { color: #4caf50; font-weight: 600; }
        .pnl-negative { color: #f44336; font-weight: 600; }
        .pnl-pending { color: #ff9800; }
    </style>
</head>
<body>
    <div class="container">
        <h1><span class="live-indicator"></span>Crypto Trading <span>Dashboard</span></h1>

        <div class="vol-stop-banner" id="volStopBanner">
            ⚠️ VOLATILITY STOP ACTIVE - Trading halted due to high volatility (>11%)
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="info-grid">
            <div class="info-card">
                <div class="label">BTC/USD</div>
                <div class="value" id="btcPrice">--</div>
            </div>
            <div class="info-card">
                <div class="label">ETH/USD</div>
                <div class="value blue" id="ethPrice">--</div>
            </div>
            <div class="info-card">
                <div class="label">Time to Settle</div>
                <div class="value" id="minsToSettle" style="color: #4caf50;">--</div>
            </div>
            <div class="info-card">
                <div class="label">P&L (12/18+)</div>
                <div class="value" id="totalPnl">--</div>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>Bankroll ($)</label>
                <input type="number" id="bankroll" value="100" min="10" step="10">
            </div>
            <div class="control-group">
                <label>Kelly Fraction</label>
                <select id="kellyFraction">
                    <option value="0.1">10% (Conservative)</option>
                    <option value="0.25" selected>25% (Quarter Kelly)</option>
                    <option value="0.5">50% (Half Kelly)</option>
                    <option value="1.0">100% (Full Kelly)</option>
                </select>
            </div>
        </div>

        <button class="refresh-btn" id="refreshBtn" onclick="refreshData()">
            Refresh Data
        </button>

        <button class="mobile-toggle" onclick="toggleMobileSections()">
            Show/Hide Charts & Details
        </button>

        <div class="main-content">
            <div class="left-column">
                <!-- BTC Contracts -->
                <div class="section-card">
                    <h2>BTC Contracts <span class="badge green">HOURLY</span></h2>
                    <div class="table-wrapper">
                        <table id="btcStrikesTable">
                            <thead>
                                <tr>
                                    <th>Strike</th>
                                    <th>Dist</th>
                                    <th>Fair</th>
                                    <th>Ask</th>
                                    <th>Edge</th>
                                    <th>Bet</th>
                                </tr>
                            </thead>
                            <tbody id="btcStrikesBody">
                                <tr><td colspan="6" class="status">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ETH Contracts -->
                <div class="section-card eth-section">
                    <h2>ETH Contracts <span class="badge blue">HOURLY</span></h2>
                    <div class="table-wrapper">
                        <table id="ethStrikesTable">
                            <thead>
                                <tr>
                                    <th>Strike</th>
                                    <th>Dist</th>
                                    <th>Fair</th>
                                    <th>Ask</th>
                                    <th>Edge</th>
                                    <th>Bet</th>
                                </tr>
                            </thead>
                            <tbody id="ethStrikesBody">
                                <tr><td colspan="6" class="status">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Trade Log with IRR -->
                <div class="section-card">
                    <h2>Trade Log <span class="badge yellow">SINCE 12/18</span></h2>
                    <div class="irr-stats" id="irrStats">
                        <div class="irr-stat">
                            <div class="stat-label">Start Balance</div>
                            <div class="stat-value">$1,000</div>
                        </div>
                        <div class="irr-stat">
                            <div class="stat-label">Current</div>
                            <div class="stat-value" id="currentBalance">--</div>
                        </div>
                        <div class="irr-stat">
                            <div class="stat-label">Return</div>
                            <div class="stat-value" id="totalReturn">--</div>
                        </div>
                        <div class="irr-stat">
                            <div class="stat-label">Win Rate</div>
                            <div class="stat-value" id="winRate">--</div>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="trade-log-table" id="tradeLogTable">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Asset</th>
                                    <th>Strike</th>
                                    <th>Bet</th>
                                    <th>Edge</th>
                                    <th>P&L</th>
                                </tr>
                            </thead>
                            <tbody id="tradeLogBody">
                                <tr><td colspan="6" class="status">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="right-column">
                <!-- Volatility Chart -->
                <div class="section-card hide-mobile" id="volSection">
                    <h2>Realized Volatility (1σ) by Window</h2>
                    <div id="volUsing" style="color: #4caf50; font-size: 0.85rem; margin-bottom: 8px; font-weight: 600;">BTC 15m: -- | ETH 15m: --</div>
                    <div class="chart-container">
                        <canvas id="volChart"></canvas>
                    </div>
                </div>

                <!-- Price Chart -->
                <div class="section-card hide-mobile">
                    <h2>BTC Price History (60 min)</h2>
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>

                <!-- Trading Status -->
                <div class="section-card">
                    <h2>Trading Status</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; text-align: center;">
                        <div>
                            <div style="color: #888; font-size: 0.65rem; text-transform: uppercase; margin-bottom: 4px;">BTC Vol</div>
                            <div id="btcVol" style="font-size: 0.95rem; font-weight: bold; color: #4caf50;">--</div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 0.65rem; text-transform: uppercase; margin-bottom: 4px;">ETH Vol</div>
                            <div id="ethVol" style="font-size: 0.95rem; font-weight: bold; color: #4caf50;">--</div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 0.65rem; text-transform: uppercase; margin-bottom: 4px;">Status</div>
                            <div id="tradingStatus" class="positive" style="font-size: 0.95rem; font-weight: bold;">--</div>
                        </div>
                        <div>
                            <div style="color: #888; font-size: 0.65rem; text-transform: uppercase; margin-bottom: 4px;">Min Edge</div>
                            <div style="font-size: 0.95rem; font-weight: bold; color: #f7931a;">4%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="last-updated" id="lastUpdated">Last updated: --</div>

        <div class="footer">
            Auto-refreshes every 30s |
            <a href="https://kalshi.com" target="_blank">Kalshi</a> |
            Data from DynamoDB
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Configuration
        const CONFIG = {
            apiBase: 'https://hj0huxe72j.execute-api.us-east-2.amazonaws.com',
            refreshInterval: 30000,
        };

        // Global state
        let volChart = null;
        let priceChart = null;
        let cachedData = null;

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            refreshData();
            setInterval(refreshData, CONFIG.refreshInterval);
        });

        // Toggle mobile sections
        function toggleMobileSections() {
            document.querySelectorAll('.hide-mobile').forEach(el => {
                el.classList.toggle('show');
            });
        }

        // Initialize Chart.js charts
        function initCharts() {
            const volCtx = document.getElementById('volChart').getContext('2d');
            const priceCtx = document.getElementById('priceChart').getContext('2d');

            // Volatility Chart - Scatter plot with trailing windows
            volChart = new Chart(volCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Volatility',
                        data: [],  // Will be populated with {x: minutes, y: vol%}
                        backgroundColor: [],  // Will be set per point (green for used, orange for others)
                        borderColor: [],
                        pointRadius: 8,
                        pointHoverRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const mins = ctx.parsed.x;
                                    const vol = ctx.parsed.y;
                                    return `${mins}m: ${vol.toFixed(3)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: {
                                color: '#888',
                                callback: (v) => v.toFixed(3) + '%'
                            },
                            title: {
                                display: false
                            }
                        },
                        x: {
                            reverse: true,  // 120m on left, 15m on right
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: {
                                color: '#888',
                                callback: (v) => v + 'm'
                            },
                            title: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Price Chart
            priceChart = new Chart(priceCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'BTC Price',
                        data: [],
                        borderColor: '#f7931a',
                        backgroundColor: 'rgba(247, 147, 26, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            ticks: {
                                color: '#888',
                                callback: (v) => '$' + (v/1000).toFixed(1) + 'k'
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: '#888',
                                maxTicksLimit: 6
                            }
                        }
                    }
                }
            });
        }

        // Refresh all data
        async function refreshData() {
            const btn = document.getElementById('refreshBtn');
            btn.innerHTML = '<span class="spinner"></span>Refreshing...';
            btn.disabled = true;

            try {
                const response = await fetch(`${CONFIG.apiBase}/dashboard/all`);
                if (!response.ok) throw new Error('API request failed');

                cachedData = await response.json();
                updateFromApiData(cachedData);
                updateStrikesTable();
                updateTradingStatus();

                document.getElementById('errorMessage').classList.remove('active');
                document.getElementById('lastUpdated').textContent =
                    'Last updated: ' + new Date().toLocaleTimeString();
            } catch (error) {
                console.error('Error refreshing data:', error);
                const errEl = document.getElementById('errorMessage');
                errEl.textContent = 'Error loading data: ' + error.message;
                errEl.classList.add('active');
            } finally {
                btn.innerHTML = 'Refresh Data';
                btn.disabled = false;
            }
        }

        // Update UI from API response
        function updateFromApiData(data) {
            // Update BTC price
            if (data.btc_price) {
                document.getElementById('btcPrice').textContent =
                    '$' + Math.round(data.btc_price).toLocaleString();
            }

            // Update ETH price
            if (data.eth_price) {
                document.getElementById('ethPrice').textContent =
                    '$' + Math.round(data.eth_price).toLocaleString();
            }

            // Update minutes to settlement
            if (data.minutes_to_settlement !== undefined) {
                document.getElementById('minsToSettle').textContent =
                    data.minutes_to_settlement + ' min';
            }

            // Update volatility for both assets
            const btcVol = data.btc_volatility || data.volatility;
            const ethVol = data.eth_volatility;

            if (btcVol) {
                const btcVol15m = btcVol['15m']?.std || 0;
                document.getElementById('btcVol').textContent = btcVol15m.toFixed(2) + '%';
                document.getElementById('btcVol').style.color = btcVol15m >= 10 ? '#f44336' : '#4caf50';

                // Check volatility stop
                const banner = document.getElementById('volStopBanner');
                if (btcVol15m >= 10) {
                    banner.classList.add('active');
                } else {
                    banner.classList.remove('active');
                }

                // Update volatility scatter chart (BTC)
                const windows = [
                    { mins: 120, vol: btcVol['120m']?.std || 0 },
                    { mins: 90, vol: btcVol['90m']?.std || 0 },
                    { mins: 60, vol: btcVol['60m']?.std || 0 },
                    { mins: 30, vol: btcVol['30m']?.std || 0 },
                    { mins: 15, vol: btcVol['15m']?.std || 0 }
                ];

                const scatterData = windows.map(w => ({ x: w.mins, y: w.vol }));
                const bgColors = windows.map(w =>
                    w.mins === 15 ? 'rgba(76, 175, 80, 0.9)' : 'rgba(255, 152, 0, 0.8)'
                );
                const borderColors = windows.map(w =>
                    w.mins === 15 ? '#4caf50' : '#ff9800'
                );

                volChart.data.datasets[0].data = scatterData;
                volChart.data.datasets[0].backgroundColor = bgColors;
                volChart.data.datasets[0].borderColor = borderColors;
                volChart.update();
            }

            if (ethVol) {
                const ethVol15m = ethVol['15m']?.std || 0;
                document.getElementById('ethVol').textContent = ethVol15m.toFixed(2) + '%';
                document.getElementById('ethVol').style.color = ethVol15m >= 10 ? '#f44336' : '#4caf50';
            }

            // Update vol display
            const btcVolDisplay = btcVol ? (btcVol['15m']?.std || 0).toFixed(2) : '--';
            const ethVolDisplay = ethVol ? (ethVol['15m']?.std || 0).toFixed(2) : '--';
            document.getElementById('volUsing').textContent = `BTC 15m: ${btcVolDisplay}% | ETH 15m: ${ethVolDisplay}%`;

            // Update price history chart
            if (data.price_history && data.price_history.length > 0) {
                const labels = data.price_history.map(p => {
                    const time = new Date(p.timestamp);
                    return time.toLocaleTimeString('en-US', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                });
                const prices = data.price_history.map(p => p.price);

                priceChart.data.labels = labels;
                priceChart.data.datasets[0].data = prices;
                priceChart.update();
            }

            // Update IRR stats
            if (data.irr_stats) {
                const irr = data.irr_stats;
                document.getElementById('currentBalance').textContent = '$' + irr.current_balance.toLocaleString();
                document.getElementById('currentBalance').className = 'stat-value ' + (irr.total_pnl >= 0 ? 'positive' : 'negative');

                const returnPct = irr.total_return_pct >= 0 ? '+' + irr.total_return_pct.toFixed(1) : irr.total_return_pct.toFixed(1);
                document.getElementById('totalReturn').textContent = returnPct + '%';
                document.getElementById('totalReturn').className = 'stat-value ' + (irr.total_return_pct >= 0 ? 'positive' : 'negative');

                document.getElementById('winRate').textContent = irr.win_rate + '%';
                document.getElementById('winRate').className = 'stat-value ' + (irr.win_rate >= 50 ? 'positive' : 'negative');

                // Update header P&L
                const pnlDisplay = irr.total_pnl >= 0 ? '+$' + irr.total_pnl.toFixed(0) : '-$' + Math.abs(irr.total_pnl).toFixed(0);
                document.getElementById('totalPnl').textContent = pnlDisplay;
                document.getElementById('totalPnl').className = 'value ' + (irr.total_pnl >= 0 ? 'green' : 'red');
            }

            // Update trade log
            if (data.trades) {
                const tbody = document.getElementById('tradeLogBody');
                if (data.trades.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="status">No trades yet</td></tr>';
                } else {
                    tbody.innerHTML = data.trades.slice(0, 15).map(t => {
                        const ts = t.timestamp ? new Date(t.timestamp) : null;
                        const timeStr = ts ? ts.toLocaleTimeString('en-US', {
                            month: 'numeric',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        }) : '--';

                        const asset = t.asset || 'BTC';
                        const assetClass = asset.toLowerCase();
                        const strike = t.strike ? '$' + Math.round(t.strike).toLocaleString() : '--';
                        const bet = t.total_cost ? '$' + t.total_cost.toFixed(0) : '--';
                        const edge = t.edge ? '+' + t.edge.toFixed(0) + '%' : '--';

                        // P&L display
                        let pnlDisplay = '--';
                        let pnlClass = 'pnl-pending';
                        if (t.pnl !== null && t.pnl !== undefined) {
                            if (t.pnl >= 0) {
                                pnlDisplay = '+$' + t.pnl.toFixed(0);
                                pnlClass = 'pnl-positive';
                            } else {
                                pnlDisplay = '-$' + Math.abs(t.pnl).toFixed(0);
                                pnlClass = 'pnl-negative';
                            }
                        } else if (t.settled === false) {
                            pnlDisplay = '⏳';
                        }

                        return `
                            <tr>
                                <td>${timeStr}</td>
                                <td><span class="asset-badge ${assetClass}">${asset}</span></td>
                                <td>${strike}</td>
                                <td>${bet}</td>
                                <td class="positive">${edge}</td>
                                <td class="${pnlClass}">${pnlDisplay}</td>
                            </tr>
                        `;
                    }).join('');
                }
            }
        }

        // Calculate and update strikes table from API data
        function updateStrikesTable() {
            const bankroll = parseFloat(document.getElementById('bankroll').value) || 100;
            const kellyFrac = parseFloat(document.getElementById('kellyFraction').value) || 0.25;

            // Update BTC strikes
            const btcStrikes = cachedData?.btc_strikes || cachedData?.strikes || [];
            const btcTbody = document.getElementById('btcStrikesBody');

            if (btcStrikes.length === 0) {
                btcTbody.innerHTML = '<tr><td colspan="6" class="status">No BTC strikes available</td></tr>';
            } else {
                btcTbody.innerHTML = btcStrikes.map(s => {
                    const adjustedBet = (s.kelly_bet || 0) * kellyFrac * (bankroll / 100);
                    const edgeClass = s.edge > 0 ? 'positive' : (s.edge < 0 ? 'negative' : '');
                    const edgeDisplay = s.edge > 0 ? '+' + s.edge : s.edge;

                    return `
                        <tr>
                            <td>$${Math.round(s.strike).toLocaleString()}</td>
                            <td>${s.distance_bps}bp</td>
                            <td class="positive">${s.fair_no_price}¢</td>
                            <td>${s.no_ask > 0 ? s.no_ask + '¢' : '--'}</td>
                            <td class="${edgeClass}">${s.no_ask > 0 ? edgeDisplay : '--'}</td>
                            <td>${adjustedBet > 0.01 ? '$' + adjustedBet.toFixed(0) : '--'}</td>
                        </tr>
                    `;
                }).join('');
            }

            // Update ETH strikes
            const ethStrikes = cachedData?.eth_strikes || [];
            const ethTbody = document.getElementById('ethStrikesBody');

            if (ethStrikes.length === 0) {
                ethTbody.innerHTML = '<tr><td colspan="6" class="status">No ETH strikes available</td></tr>';
            } else {
                ethTbody.innerHTML = ethStrikes.map(s => {
                    const adjustedBet = (s.kelly_bet || 0) * kellyFrac * (bankroll / 100);
                    const edgeClass = s.edge > 0 ? 'positive' : (s.edge < 0 ? 'negative' : '');
                    const edgeDisplay = s.edge > 0 ? '+' + s.edge : s.edge;

                    return `
                        <tr>
                            <td>$${Math.round(s.strike).toLocaleString()}</td>
                            <td>${s.distance_bps}bp</td>
                            <td class="positive">${s.fair_no_price}¢</td>
                            <td>${s.no_ask > 0 ? s.no_ask + '¢' : '--'}</td>
                            <td class="${edgeClass}">${s.no_ask > 0 ? edgeDisplay : '--'}</td>
                            <td>${adjustedBet > 0.01 ? '$' + adjustedBet.toFixed(0) : '--'}</td>
                        </tr>
                    `;
                }).join('');
            }
        }

        // Update trading status
        function updateTradingStatus() {
            const btcVolText = document.getElementById('btcVol').textContent;
            const btcVol = parseFloat(btcVolText) || 0;
            const statusEl = document.getElementById('tradingStatus');

            if (btcVol >= 10) {
                statusEl.textContent = 'STOPPED';
                statusEl.style.color = '#f44336';
            } else {
                statusEl.textContent = 'ACTIVE';
                statusEl.style.color = '#4caf50';
            }
        }

        // Recalculate on input change
        document.getElementById('bankroll').addEventListener('change', updateStrikesTable);
        document.getElementById('kellyFraction').addEventListener('change', updateStrikesTable);
    </script>
</body>
</html>
